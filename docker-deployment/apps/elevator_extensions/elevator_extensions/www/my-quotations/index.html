{# My Quotations - Customer Portal #}
{% extends "templates/web.html" %}

{% block title %}My Quotations{% endblock %}

{% block page_content %}
<div class="container my-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="fa fa-file-text-o mr-2"></i>My Quotations</h2>
    </div>

    <div id="quotations-container">
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="text-muted mt-2">Loading quotations...</p>
        </div>
    </div>
</div>

<!-- Quotation Detail Modal -->
<div class="modal fade" id="quotation-modal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modal-title">Quotation Details</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" id="modal-body">
                <div class="text-center py-3">
                    <div class="spinner-border text-primary" role="status"></div>
                </div>
            </div>
            <div class="modal-footer" id="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Decline Modal -->
<div class="modal fade" id="decline-modal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Decline Quotation</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="decline-quotation-name">
                <div class="form-group">
                    <label for="decline-reason">Reason for declining (optional):</label>
                    <textarea id="decline-reason" class="form-control" rows="3"
                        placeholder="Please let us know why you're declining this quotation..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="confirmDecline()">
                    <i class="fa fa-times"></i> Decline Quotation
                </button>
            </div>
        </div>
    </div>
</div>

<style>
    .quotation-card {
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        margin-bottom: 16px;
        transition: box-shadow 0.2s;
    }

    .quotation-card:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .quotation-header {
        padding: 16px;
        border-bottom: 1px solid #f0f0f0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .quotation-body {
        padding: 16px;
    }

    .quotation-actions {
        padding: 12px 16px;
        background: #f8f9fa;
        border-top: 1px solid #e0e0e0;
        border-radius: 0 0 8px 8px;
    }

    .status-badge {
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 500;
    }

    .status-open {
        background: #fff3cd;
        color: #856404;
    }

    .status-accepted {
        background: #d4edda;
        color: #155724;
    }

    .status-declined {
        background: #f8d7da;
        color: #721c24;
    }

    .status-ordered {
        background: #cce5ff;
        color: #004085;
    }

    .amount-display {
        font-size: 24px;
        font-weight: 600;
        color: #2c3e50;
    }

    .valid-till {
        font-size: 13px;
        color: #6c757d;
    }

    .item-table th {
        background: #f8f9fa;
        font-weight: 500;
        font-size: 13px;
    }

    .btn-action {
        margin-right: 8px;
        margin-bottom: 8px;
    }
</style>

<script>
    frappe.ready(function () {
        loadQuotations();
    });

    function loadQuotations() {
        frappe.call({
            method: 'elevator_extensions.portal_api.get_customer_quotations',
            callback: function (r) {
                if (r.message && r.message.length) {
                    renderQuotations(r.message);
                } else {
                    $('#quotations-container').html(`
                    <div class="text-center py-5">
                        <i class="fa fa-file-text-o fa-4x text-muted mb-3"></i>
                        <h4 class="text-muted">No Quotations Found</h4>
                        <p class="text-muted">You don't have any quotations yet.</p>
                    </div>
                `);
                }
            },
            error: function (err) {
                $('#quotations-container').html(`
                <div class="alert alert-danger">
                    <i class="fa fa-exclamation-triangle"></i> 
                    Error loading quotations. Please try again later.
                </div>
            `);
            }
        });
    }

    function renderQuotations(quotations) {
        var html = '';

        quotations.forEach(function (q) {
            var statusClass = 'status-open';
            var statusText = q.status || 'Open';

            if (q.customer_accepted) {
                statusClass = 'status-accepted';
                statusText = 'Accepted';
            } else if (q.customer_declined) {
                statusClass = 'status-declined';
                statusText = 'Declined';
            }

            var validTill = q.valid_till ? new Date(q.valid_till).toLocaleDateString() : 'N/A';
            var txnDate = q.transaction_date ? new Date(q.transaction_date).toLocaleDateString() : 'N/A';

            html += `
            <div class="quotation-card">
                <div class="quotation-header">
                    <div>
                        <h5 class="mb-1">${q.name}</h5>
                        <small class="text-muted">Date: ${txnDate}</small>
                    </div>
                    <span class="status-badge ${statusClass}">${statusText}</span>
                </div>
                <div class="quotation-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p class="amount-display">${formatCurrency(q.grand_total)}</p>
                            <p class="valid-till">Valid until: ${validTill}</p>
                        </div>
                        <div class="col-md-6 text-md-right">
                            ${q.customer_remarks ? `<p class="small text-muted"><strong>Your remarks:</strong> ${q.customer_remarks}</p>` : ''}
                        </div>
                    </div>
                </div>
                <div class="quotation-actions">
                    <button class="btn btn-outline-primary btn-sm btn-action" onclick="viewDetails('${q.name}')">
                        <i class="fa fa-eye"></i> View Details
                    </button>
                    <button class="btn btn-outline-secondary btn-sm btn-action" onclick="downloadPDF('${q.name}')">
                        <i class="fa fa-download"></i> Download PDF
                    </button>
                    ${!q.customer_accepted && !q.customer_declined ? `
                        <button class="btn btn-success btn-sm btn-action" onclick="acceptQuotation('${q.name}')">
                            <i class="fa fa-check"></i> Accept Quotation
                        </button>
                        <button class="btn btn-outline-danger btn-sm btn-action" onclick="showDeclineModal('${q.name}')">
                            <i class="fa fa-times"></i> Decline
                        </button>
                    ` : ''}
                </div>
            </div>
        `;
        });

        $('#quotations-container').html(html);
    }

    function formatCurrency(amount) {
        return new Intl.NumberFormat('en-US', {
            style: 'currency',
            currency: 'EUR'
        }).format(amount || 0);
    }

    function viewDetails(name) {
        $('#modal-title').text('Quotation: ' + name);
        $('#modal-body').html('<div class="text-center py-3"><div class="spinner-border text-primary"></div></div>');
        $('#quotation-modal').modal('show');

        frappe.call({
            method: 'elevator_extensions.portal_api.get_quotation_details',
            args: { quotation_name: name },
            callback: function (r) {
                if (r.message) {
                    var q = r.message;
                    var html = `
                    <div class="mb-3">
                        <strong>Customer:</strong> ${q.party_name}<br>
                        <strong>Date:</strong> ${q.transaction_date}<br>
                        <strong>Valid Until:</strong> ${q.valid_till || 'N/A'}
                    </div>
                    <table class="table table-sm item-table">
                        <thead>
                            <tr>
                                <th>Item</th>
                                <th class="text-right">Qty</th>
                                <th class="text-right">Rate</th>
                                <th class="text-right">Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                    (q.items || []).forEach(function (item) {
                        html += `
                        <tr>
                            <td>${item.item_name || item.item_code}</td>
                            <td class="text-right">${item.qty}</td>
                            <td class="text-right">${formatCurrency(item.rate)}</td>
                            <td class="text-right">${formatCurrency(item.amount)}</td>
                        </tr>
                    `;
                    });

                    html += `
                        </tbody>
                        <tfoot>
                            <tr>
                                <th colspan="3" class="text-right">Grand Total:</th>
                                <th class="text-right">${formatCurrency(q.grand_total)}</th>
                            </tr>
                        </tfoot>
                    </table>
                `;

                    if (q.terms) {
                        html += `<div class="mt-3"><strong>Terms & Conditions:</strong><br>${q.terms}</div>`;
                    }

                    $('#modal-body').html(html);
                }
            },
            error: function () {
                $('#modal-body').html('<div class="alert alert-danger">Error loading details.</div>');
            }
        });
    }

    function downloadPDF(name) {
        window.open('/api/method/frappe.utils.print_format.download_pdf?doctype=Quotation&name=' + name + '&format=Standard', '_blank');
    }

    function acceptQuotation(name) {
        frappe.confirm(
            '<strong>Accept this quotation?</strong><br><br>By accepting, you agree to the terms and conditions outlined in the quotation.',
            function () {
                frappe.call({
                    method: 'elevator_extensions.portal_api.accept_quotation',
                    args: { quotation_name: name },
                    freeze: true,
                    freeze_message: 'Processing...',
                    callback: function (r) {
                        if (r.message && r.message.status === 'success') {
                            frappe.msgprint({
                                title: 'Success',
                                indicator: 'green',
                                message: r.message.message
                            });
                            loadQuotations();
                        }
                    }
                });
            }
        );
    }

    function showDeclineModal(name) {
        $('#decline-quotation-name').val(name);
        $('#decline-reason').val('');
        $('#decline-modal').modal('show');
    }

    function confirmDecline() {
        var name = $('#decline-quotation-name').val();
        var reason = $('#decline-reason').val();

        frappe.call({
            method: 'elevator_extensions.portal_api.decline_quotation',
            args: {
                quotation_name: name,
                reason: reason
            },
            freeze: true,
            freeze_message: 'Processing...',
            callback: function (r) {
                $('#decline-modal').modal('hide');
                if (r.message && r.message.status === 'success') {
                    frappe.msgprint({
                        title: 'Quotation Declined',
                        indicator: 'orange',
                        message: r.message.message
                    });
                    loadQuotations();
                }
            }
        });
    }
</script>
{% endblock %}